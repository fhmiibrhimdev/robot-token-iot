<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Listrik</title>
    <link rel="stylesheet" href="public/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/flowbite@1.4.7/dist/flowbite.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=Quantico:ital@1&display=swap" rel="stylesheet">

</head>

<body onload="startConnect()" class="bg-gray-700" style="font-family: 'Inter', sans-serif;
font-family: 'Quantico', sans-serif;">

    <div class="max-w-lg mx-auto mt-10">
        <div class="bg-gray-100 px-10 py-4 rounded-tr-lg rounded-tl-lg shadow-2xl shadow-black">
            <div class="font-bold mt-2 " style="text-shadow: 1px 1px black;">
                <p>SMI-810 V2 KWH METER PRABAYAR</p>
                <p>FASE TUNGGAL 2 KAWAT</p>
                <button></button>
            </div>
            <div class="bg-slate-900 shadow-inner shadow-black px-4 py-4 rounded-lg mt-3 mb-3 text-center"
                style="text-shadow: 2px 2px black;">
                <p class="text-[11px] font-extrabold text-yellow-500">NOMOR TOKEN: <span id="lengthToken"></span></p>
                <input type="text" readonly
                    class="w-full bg-transparent border border-transparent text-center text-base font-bold text-white focus:border-transparent focus:ring-0"
                    id="tokenVal" style="text-shadow: 1px 1px black;" value="P  E  r  i  k  S  A">
            </div>
            <div class="bg-slate-900 shadow-inner shadow-black p-4 rounded-lg mt-3 mb-3 text-center">
                <center>
                    <img class="text-center object-cover rounded-lg w-full" id="statcam" src= />

                </center>
            </div>
            <div class="ml-4">
                <i class="fa-solid fa-barcode text-lg"></i><i class="fa-solid fa-barcode text-lg"></i><i
                    class="fa-solid fa-barcode text-lg"></i><i class="fa-solid fa-barcode text-lg"></i><i
                    class="fa-solid fa-barcode text-lg"></i>
            </div>
            <div class="flex">
                <p class="text-[8px] ml-7 font-bold">##### #### ####</p>
                <button id="getCamera" class="bg-gray-400 shadow-inner shadow-black px-4 py-2 rounded-lg ml-auto mt-[-25px] hover:bg-gray-500">
                    <i class="fas fa-camera text-slate-900"></i>
                </button>
            </div>
            <center class="mb-7">
                <div class="w-64 mt-4">
                    <div class="bg-gray-600 p-4 rounded-lg shadow-inner shadow-black">
                        <div class="grid grid-cols-3 gap gap-2 font-bold">
                            <div>
                                <input type="button" id="angka1" value="1"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka2" value="2"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka3" value="3"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka4" value="4"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka5" value="5"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka6" value="6"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka7" value="7"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka8" value="8"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <input type="button" id="angka9" value="9"
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <button
                                    class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2"
                                    id="backspace">
                                    <- </button> </div> <div>
                                        <input type="button" id="angka0" value="0"
                                            class="bg-gray-400 hover:bg-gray-500 shadow-md shadow-black rounded-lg w-full py-2">
                            </div>
                            <div>
                                <button
                                    class="bg-red-400 hover:bg-red-500 shadow-md md-5 shadow-black rounded-lg w-full py-2"
                                    id="send-data">-></button>
                            </div>
                        </div>
                    </div>


                </div>
            </center>
            <div class="-mb-4" style="border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 50px
            solid rgb(75, 85, 99)">

            </div>
        </div>
        <center>
            <p class="bg-gray-600 text-white font-bold" style="text-shadow: 2px 2px black;">
                Version 3.8 Stabil
                <span id="trash-message" class="hidden"></span>
            </p>
        </center>
        <center>
            <div class="bg-gray-600 px-5 py-7 rounded-br-lg rounded-bl-lg">
            </div>
        </center>
    </div>

    <script src="public/js/jquery-3.6.0.js"></script>
    <script src="https://unpkg.com/flowbite@1.4.7/dist/flowbite.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js" type="text/javascript">
    </script>
    <script src="public/js/demo.js"></script>
    <script>
        $(document).ready(function () {


            $('#getCamera').click(function (e) { 
                message = new Paho.MQTT.Message("DONE")
                message.destinationName = "token/stat";
                client.send(message);
                Swal.fire({
                    icon: 'warning',
                    title: 'Mohon Tunggu',
                    text: 'Camera sedang mengambil gambar!...',
                })
            });

            function detectLengthInput() {
                var foo = $('#tokenVal').val().split("-").join("")
                if (foo.length > 0) {
                    foo = foo.match(new RegExp('.{1,4}', 'g')).join("-");
                }
                $('#tokenVal').val(foo);
            }

            function backspaceInput() {
                var d = $('#tokenVal').val()
                $('#tokenVal').val(d.slice(0, -1))
                tokenVal.pop()
                var lengthTokenVal = document.getElementById("tokenVal").value.length
                $('#lengthToken').html(lengthTokenVal)
            }

            let tokenVal = []
            let angka = []

            for (let i = 0; i < 11; i++) {
                $('#angka' + i).click(function (e) {
                    $(this).each(function () {
                        angka[i] = $(this).val()
                        tokenVal.push(angka[i])
                        // alert(tokenVal.join(""))
                    })
                    $('#tokenVal').val(tokenVal.join(""))

                    var lengthTokenVal = document.getElementById("tokenVal").value.length
                    $('#lengthToken').html(lengthTokenVal)
                    if (lengthTokenVal > 20) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Angka tidak boleh lebih dari 20!',
                        })
                        var d = $('#tokenVal').val()
                        $('#tokenVal').val(d.slice(0, -1))
                        tokenVal.pop()
                        var lengthTokenVal = document.getElementById("tokenVal").value.length
                        $('#lengthToken').html(lengthTokenVal)

                        detectLengthInput()
                        return false;
                    }
                    detectLengthInput()
                });
            }
            $('#backspace').click(function (e) {
                backspaceInput()
            });
            $('#send-data').click(function (e) {
                Swal.fire({
                    title: 'Apakah anda yakin?',
                    text: "Robot token akan berjalan!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, Mulai!'
                }).then((result) => {
                    if (result.isConfirmed) {

                        let timerInterval
                        Swal.fire({
                            title: 'Tunggu sebentar!',
                            html: 'Robot Token sedang kalibrasi. Kotak dialog ini akan tertutup sendiri dalam hitungan <b></b> milliseconds.',
                            timer: 2000,
                            timerProgressBar: true,
                            didOpen: () => {
                                Swal.showLoading()
                                const b = Swal.getHtmlContainer()
                                    .querySelector('b')
                                timerInterval = setInterval(() => {
                                    b.textContent = Swal
                                        .getTimerLeft()
                                }, 100)
                            },
                            willClose: () => {
                                clearInterval(timerInterval)
                            }
                        }).then((result) => {

                        })

                        setTimeout(() => {
                            Swal.fire(
                                'Berhasil!',
                                'Robot sedang dijalankan secara automatis.',
                                'success'
                            )
                        }, 2500);
                        message = new Paho.MQTT.Message("go" + tokenVal.join("") + ">")
                        message.destinationName = "power/token";
                        client.send(message);
                    }
                })
            });
        });
    </script>


</body>

</html>